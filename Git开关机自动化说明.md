# Git开关机自动化解决方案

## 📁 文件说明

- `shutdown_git_commit.bat` - 关机时自动提交脚本
- `startup_git_pull.bat` - 开机时自动拉取脚本
- `setup_shutdown_startup_tasks.ps1` - 设置任务计划的PowerShell脚本
- `manage_git_tasks.bat` - 任务管理工具（推荐使用）
- `test_git_path.bat` - Git路径测试工具
- `Git开关机自动化说明.md` - 本说明文档

## 🚀 功能特性

### 关机时自动提交
- ✅ 自动检测工作区更改
- ✅ 自动添加所有更改到暂存区
- ✅ 生成带时间戳的提交信息
- ✅ 自动提交到本地仓库
- ✅ 自动推送到远程仓库（如果配置）
- ✅ 智能检测：无更改时不执行提交

### 开机时自动拉取
- ✅ 自动检查远程仓库配置
- ✅ 自动获取远程分支信息
- ✅ 智能处理未提交的更改（自动暂存）
- ✅ 自动拉取最新代码
- ✅ 自动恢复暂存的更改
- ✅ 显示最新提交信息

## 📋 使用方法

### 方法1：使用管理工具（推荐）

直接运行管理工具：
```batch
manage_git_tasks.bat
```

管理工具提供以下功能：
1. 设置关机提交 + 开机拉取任务
2. 删除所有Git任务
3. 手动执行关机提交
4. 手动执行开机拉取
5. 查看任务状态
6. 测试脚本功能

### 方法2：手动设置

1. **以管理员身份运行PowerShell**
   - 右键点击开始菜单
   - 选择"Windows PowerShell (管理员)"

2. **执行设置脚本**
   ```powershell
   cd "C:\Users\eason\Desktop\script"
   .\setup_shutdown_startup_tasks.ps1
   ```

3. **删除任务（如需要）**
   ```powershell
   .\setup_shutdown_startup_tasks.ps1 -Remove
   ```

### 方法3：手动执行脚本

- **手动执行关机提交**：双击 `shutdown_git_commit.bat`
- **手动执行开机拉取**：双击 `startup_git_pull.bat`

## ⚙️ 配置说明

### 修改目标目录
如果需要修改Git操作的目录，请编辑以下文件中的 `TARGET_DIR` 变量：

1. `shutdown_git_commit.bat` 第12行
2. `startup_git_pull.bat` 第12行

```batch
set "TARGET_DIR=D:\frontend\my-journal-planning"
```

### 修改提交信息格式
可以修改提交信息的格式：

**关机提交**（`shutdown_git_commit.bat` 第50行）：
```batch
set "COMMIT_MSG=关机前自动提交 - %TIMESTAMP%"
```

**开机拉取**（`startup_git_pull.bat` 第50行）：
```batch
git stash push -m "开机前自动暂存 - %TIMESTAMP%"
```

## 🔧 任务计划说明

### 关机提交任务
- **任务名称**：`GitShutdownCommit`
- **触发条件**：系统关机时
- **执行权限**：SYSTEM（系统级权限）
- **运行级别**：最高权限

### 开机拉取任务
- **任务名称**：`GitStartupPull`
- **触发条件**：系统启动时
- **执行权限**：当前用户
- **网络要求**：需要网络连接

## ⚠️ 注意事项

### 系统要求
1. **Git仓库**：目标目录必须是Git仓库
2. **网络连接**：拉取操作需要网络连接
3. **管理员权限**：设置任务计划需要管理员权限
4. **远程仓库**：拉取功能需要配置远程仓库

### 安全考虑
1. **关机任务**：使用SYSTEM权限运行，确保关机时能正常执行
2. **开机任务**：使用用户权限运行，避免权限过高
3. **暂存机制**：开机拉取时会自动暂存未提交的更改

### 故障排除
1. **任务不执行**：检查任务计划程序中的任务状态
2. **权限错误**：确保以管理员权限创建了任务
3. **网络错误**：检查网络连接和远程仓库地址
4. **Git错误**：检查Git配置和仓库状态

## 📊 工作流程

### 关机流程
```
系统关机 → 触发关机任务 → 检查工作区 → 添加更改 → 提交 → 推送 → 完成
```

### 开机流程
```
系统启动 → 触发开机任务 → 检查远程仓库 → 暂存本地更改 → 拉取最新代码 → 恢复暂存 → 完成
```

## 🛠️ 高级配置

### 自定义触发器
可以通过任务计划程序修改触发条件：
- 修改执行时间
- 添加其他触发条件
- 设置延迟执行

### 日志记录
脚本执行时会显示详细的操作信息，包括：
- 当前操作步骤
- 执行结果状态
- 错误信息（如果有）
- 时间戳信息

### 错误处理
- 自动检测各种错误情况
- 提供详细的错误信息
- 优雅处理异常情况
- 确保系统稳定性

## 📞 技术支持

如果遇到问题，请检查：
1. 任务计划程序中的任务状态
2. 脚本文件是否存在且可执行
3. Git仓库配置是否正确
4. 网络连接是否正常
5. 权限设置是否正确

## 🔄 更新说明

如需更新脚本：
1. 备份当前配置
2. 替换脚本文件
3. 重新运行设置脚本
4. 测试功能是否正常
